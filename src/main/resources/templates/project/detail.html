<!DOCTYPE html>
<html lang="ko" xmlns:th="http://thymeleaf.org" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="_csrf" th:content="${_csrf.token}">
	<meta name="_csrf_header" th:content="${_csrf.headerName}">
	<th:block th:replace="fragments/commonHead"></th:block>
	<link th:href="@{/css/project_detail.css}" rel="stylesheet">
</head>

<body>
	<div class="wrap">
		<header th:replace="fragments/header.html :: fg-header"></header>

		<!-- 해당 페이지 클래스명을 적어주세요-->
		<div class="project_detail">
			<div class="container">
				<div class="project_title">
					<span class="pj_tag" th:text="${vo.prCategory}"></span>
					<h2 th:text="${vo.prTitle}"></h2>
					<div class="writer">
						<div class="profile_img" style="background:url(../images/atom02.png) 50% 50% no-repeat;background-size:cover;"></div>
						<a href="#" th:text="${vo.prWriter}"></a>
					</div>
				</div>
				<div class="row">
					<div class="col-12 col-md-8">
						<img src="../images/temp/pj_img.jpg">
					</div>
					<div class="col-12 col-md-4">
						<div class="pj_state">
							<dl>
								<dt>모인금액</dt>
								<dd>
									<strong>1,757,000</strong>원 &nbsp;&nbsp;/&nbsp;&nbsp; 달성률 <b>58%</b>
								</dd>
								<dt>남은시간</dt>
								<dd>
									<strong>10</strong>일
								</dd>
								<dt>후원자</dt>
								<dd>
									<strong>69</strong>명
								</dd>
							</dl>
						</div>
						<div class="help_box">
							<h4>펀딩 진행중</h4>
							<p>목표 금액인 3,000,000원이 모여야만 결제됩니다.<br>결제는 2021년 8월 14일에 다함께 진행됩니다.</p>
						</div>
						<div class="sponsor">
							<button type="button" class="btn btn-outline-secondary btn_like">
								<i class="far fa-heart"></i>
								<!-- <i class="fas fa-heart"></i> -->
							</button>
							<button type="button" class="btn btn-primary btn_sponsor">이 프로젝트 후원하기</button>
						</div>
					</div>
				</div>
				<div class="row">
					<ul class="tab_menu">
						<li class="tab_01 active"><a href="javascript:;">스토리</a></li>
						<li class="tab_02"><a href="javascript:;">커뮤니티<span class="count">2</span></a></li>
						<li class="tab_03"><a href="javascript:;">펀딩안내</a></li>
					</ul>
				</div>
			</div>
			
			<div class="container-fluide">
				<div class="container">
					<div class="row">
						<div class="col-12 col-md-8 project_content">
							<div id="story" style="display:block;">
								<div class="story_contents" th:text="${vo.prContents}">
							
								</div>
							</div>
							<div id="community" style="display:none;">
								<div class="community_contents">
									<button type="button" class="btn btn-dark btn-addComt" data-bs-toggle="modal" data-bs-target="#community_modal">커뮤니티 글 작성하기</button>
									<div class="post_list">
										<div class="post">
											<div class="pf_wrap">
												<div class="pf_img" style="background:url(../images/atom02.png) 50% 50% no-repeat;background-size:cover;"></div>
												<div class="pf_link">
													<a href="#">
														<span class="name">후원자홍길동 </span>
														<i class="fas fa-angle-right"></i>
													</a>
													<span class="date">2021.7.11 12:58</span>
												</div>
												<button type="button" class="btn btn-sm btn-secondary">수정/삭제 하기</button>
											</div>
											<div class="txt">
												<p>
													안녕하세요 우선 펀딩 올려주셔서 감사합니다.<br><br>
													다름이 아니라.. 펀딩 알림신청을 했을때 봤던 표지와 지금 표지가 다른 것 같은데 (아니라면 죄송합니다.)<br><br>
													개인적으로는 펀딩 예고때 올리셨던 갈색? 표지가 더 괜찮았는데ㅠㅠㅠ 혹시 표지가 달라질 예정은 없으실까요..?
												</p>
											</div>
											<p class="cmt_amount"><b>2</b>개의 댓글이 있습니다.</p>
											<div class="cmt_wrap">
												<div class="cmt">
													<div class="pf_wrap">
														<div class="pf_img" style="background:url(../images/atom02.png) 50% 50% no-repeat;background-size:cover;"></div>
														<div class="pf_link">
															<a href="#">
																<span class="name">잉어(-ing-er)</span>
																<i class="fas fa-angle-right"></i>
															</a>
															<span class="date">2021.7.11 12:58</span>
														</div>
													</div>
													<div class="txt">
														<p>안녕하세요. 더쿠문고입니다. 먼저 저희 서적에 관심을 가져주셔서 감사합니다. 공개예정 때 썸네일에 들어가 있던 이미지는 공개 전 가안이었으며 현재 공개 후에는 해당페이지의 이미지로 결정되었습니다. 표지는 더 이상 변경 없이 진행되는 점 양해부탁드립니다. 감사합니다.</p>
													</div>
												</div>
												<div class="cmt">
													<div class="pf_wrap">
														<div class="pf_img" style="background:url(../images/atom02.png) 50% 50% no-repeat;background-size:cover;"></div>
														<div class="pf_link">
															<a href="#">
																<span class="name">후원자홍길동 </span>
																<i class="fas fa-angle-right"></i>
															</a>
															<span class="date">2021.7.11 12:58</span>
														</div>
													</div>
													<div class="txt">
														<p>답변감사합니다!!!!</p>
													</div>
												</div>
											</div>
										</div> 

										<!-- <div class="post">
											<div class="pf_wrap">
												<div class="pf_img" style="background:url(../images/atom02.png) 50% 50% no-repeat;background-size:cover;"></div>
												<div class="pf_link">
													<a href="#">
														<span class="name">후원자홍길동 </span>
														<i class="fas fa-angle-right"></i>
													</a>
													<span class="date">2021.7.11 12:58</span>
												</div>
											</div>
											<div class="txt">
												<p>
													안녕하세요 우선 펀딩 올려주셔서 감사합니다.<br><br>
													다름이 아니라.. 펀딩 알림신청을 했을때 봤던 표지와 지금 표지가 다른 것 같은데 (아니라면 죄송합니다.)<br><br>
													개인적으로는 펀딩 예고때 올리셨던 갈색? 표지가 더 괜찮았는데ㅠㅠㅠ 혹시 표지가 달라질 예정은 없으실까요..?
												</p>
											</div>
											<p class="cmt_amount"><b>2</b>개의 댓글이 있습니다.</p>
											<div class="cmt_wrap">
												<div class="cmt">
													<div class="writer">
														<span class="p_img" style="background:url(../images/atom02.png) 50% 50% no-repeat;background-size:cover;"></span>
														<a href="#" class="name">잉어(-ing-er)</a>
														<span class="tag">창작자</span>
														<span class="regdate">2021.7.11 12:58</span>
													</div>
													<div class="pf_wrap">
														<div class="pf_img" style="background:url(../images/atom02.png) 50% 50% no-repeat;background-size:cover;"></div>
														<div class="pf_link">
															<a href="#">
																<span class="name">후원자홍길동 </span>
																<i class="fas fa-angle-right"></i>
															</a>
															<span class="date">2021.7.11 12:58</span>
														</div>
													</div>
													<div class="txt">
														<p>안녕하세요. 더쿠문고입니다. 먼저 저희 서적에 관심을 가져주셔서 감사합니다. 공개예정 때 썸네일에 들어가 있던 이미지는 공개 전 가안이었으며 현재 공개 후에는 해당페이지의 이미지로 결정되었습니다. 표지는 더 이상 변경 없이 진행되는 점 양해부탁드립니다. 감사합니다.</p>
													</div>
												</div>
												<div class="cmt">
													<div class="profile sponsor">
														<span class="p_img" style="background:url(../images/atom02.png) 50% 50% no-repeat;background-size:cover;"></span>
														<a href="#" class="name">후원자 홍길동</a>
														<span class="regdate">2021.7.11 12:58</span>
													</div>
													<div class="txt">
														<p>답변감사합니다!!!!</p>
													</div>
												</div>
											</div>
										</div> -->
									</div>
									<div class="no_data">
										<i class="far fa-meh"></i>
										<p>게시글이 없습니다.</p>
									</div>
								</div>
							</div>
							<div id="guide" style="display:none;">
								<div class="guide_contents">
									<h4>이 프로젝트의 환불 및 교환 정책</h4>
									<ul>
										<li>- 프로젝트 마감일 후에는 즉시 제작 및 실행에 착수하는 프로젝트 특성상 단순 변심에 의한 후원금 환불이 불가능합니다.</li>
										<li>- 예상 전달일로부터 30일 이상 선물 전달이 이뤄지지 않을 경우, 환불을 원하시는 분들께는 수수료를 제한 후원금을 환불해 드립니다.<br>
										(플랫폼 수수료: 모금액의 5%, 부가세 별도 / 결제 수수료: 결제 성공액의 3%, 부가세 별도 )</li>
										<li>- 선물 전달을 위한 배송지 및 서베이 답변은 2021년 9월 1일에 일괄 취합할 예정입니다.(변경시 커뮤니티에 공지)</li>
										<li>- 이후 배송지 변경이나 서베이 답변 변경을 원하실 때에는 '창작자에게 문의하기'로 개별 문의하셔야 합니다.</li>
										<li>- 파손 또는 불량품 수령 시 14일 이내로 교환이 가능합니다.</li>
										<li>- 교환 및 AS 문의는 '창작자에게 문의하기'로 신청해 주세요.</li>
										<li>- 파손이나 불량품 교환시 발생하는 비용은 창작자가 부담합니다. 선물 확인을 위한 포장 훼손 외에 아이템의 가치가 훼손된 경우에는 교환 및 환불이 불가합니다.</li>
										<li>- 오타의 이유로 환불, 교환은 불가능합니다. 페이지 리딩에 지장이 없을 정도의 인쇄파손 및 오류는 교환, 환불이 불가능합니다.</li>
										<li>- 파본을 전달 받으실 경우 교환은 가능하며 환불은 불가능 합니다. 파본 교환은 최대 2번까지만 가능합니다.</li>
										<li>- 후원자가 배송지를 잘못 기재하거나 창작자에게 사전 고지 없이 배송지를 수정하여 배송사고가 발생할 경우 창작자는 책임을 지지 않습니다.</li>
									</ul>
								</div>
							</div>
						</div>
						<div class="col-12 col-md-4">
							<div class="writer_profile">
								<h4>창작자 소개</h4>
								<div class="writer">
									<div class="pf_wrap">
										<div class="pf_img" style="background:url(../images/atom02.png) 50% 50% no-repeat;background-size:cover;"></div>
										<div class="pf_link">
											<a href="#">
												<span class="name" th:text="${vo.prWriter}"></span>
											</a>
										</div>
									</div>
								</div>
								<div class="info">
									<p class="txt" th:text="${vo.prWriterintro}"></p>
									<dl>
										<dt>진행한 프로젝트</dt>
										<dd><em>15</em></dd>
										<dt>후원한 프로젝트</dt>
										<dd><em>115</em></dd>
									</dl>
									<button type="button" class="btn btn-outline-secondary w-100 btn-qna" data-bs-toggle="modal" data-bs-target="#qna_modal">
										<i class="far fa-envelope"></i> 문의하기
									</button>
								</div>
							</div>
							<div class="payment _01">
								<h4>후원하기</h4>
								<p class="money"><strong>+10000</strong></p>
								<p>추가 후원금(선택)</p>
								<input type="text" id="add_money" class="form-control" placeholder="0">
								<p class="s_txt">- 더 후원해주시면 프로젝트 성사가 앞당겨집니다.</p>
								<div class="btn_wrap">
									<button type="button" id="pay_01" class="btn btn-sm btn-outline-secondary">+ 1만 원</button>
									<button type="button" id="pay_02" class="btn btn-sm btn-outline-secondary">+ 30만 원</button>
									<button type="button" id="pay_03" class="btn btn-sm btn-outline-secondary">+ 50만 원</button>
									<button type="button" id="pay_04" class="btn btn-sm btn-outline-secondary">+ 100만 원</button>
								</div>
								<button type="button" class="btn btn-primary w-100" id="btn_payment">1만 원 후원하기</button>
							</div>
							<div class="payment _02">
								<h4>결제하기</h4>
								<p class="money"><strong id="payment_money">+1000</strong></p>
								<p>수량 선택</p>
								<!-- <input type="text" id="add_money" class="form-control" placeholder="0"> -->

								<div class="incremental-input" id="counter-input">
									<button type="button" class="btn btn-sm btn-outline-secondary btn_minus">-</button>
									<span class="count">1</span>
									<button type="button" class="btn btn-sm btn-outline-secondary btn_plus">+</button>
								</div> 
								<button type="button" class="btn btn-primary w-100" id="btn_payment"><strong class="result_money">1000</strong>원 결제하기</button>
							</div>
						</div>
					</div>

				</div>
			</div>

			<!-- QnA Modal -->	
			<div class="modal fade" id="qna_modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">창작자에게 문의</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<dl>
								<dt>받는사람</dt>
								<dd>
									<input type="text" class="form-control" id="receiver" value="" readonly placeholder="작성자닉네임">
								</dd>
								<dt>문의내용</dt>
								<dd>
									<select class="form-select" id="qna_category">
										<option value="">문의유형</option>
										<option value="선물/후원">선물/후원</option>
										<option value="프로젝트">프로젝트</option>
										<option value="수령자 정보">수령자 정보</option>
										<option value="배송">배송</option>
										<option value="기타">기타</option>
									</select>
								</dd>
							</dl>
							<textarea class="form-control" id="qna_contents" rows="5" col="20" placeholder="프로젝트 진행자에게 문의하고 싶은 내용을 적어주세요."></textarea>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
							<button type="button" class="btn btn-primary" id="addQnaBtn">등록 하기</button>
						</div>
					</div>
				</div>
			</div>
		
			<!-- Community Modal -->	
			<div class="modal fade" id="community_modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
				<div class="modal-dialog modal-dialog-centered">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">커뮤니티</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<dl>
								<dt>제목</dt>
								<dd>
									<input type="text" class="form-control" id="com_title" placeholder="제목을 입력해주세요.">
								</dd>
								<dt>작성 내용</dt>
								<dd>
									<textarea class="form-control" id="com_contents" rows="15" col="20" placeholder="커뮤니티에 작성하실 글을 입력해 주세요."></textarea>
								</dd>
							</dl>
							
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
							<button type="button" class="btn btn-primary" id="addCommunityBtn">등록 하기</button>
						</div>
					</div>
				</div>
			</div>
			
			<input type="hidden" id="pno" name="pno" th:value="${vo.pno}">
		</div>
	</div>
	<script th:inline="javascript" th:src="@{/js/community.js}"></script>
	<script type="text/javascript" >
	 	var pno = $("#pno").val();
		$(function(){
			console.log('pno : ' + pno);
			
		/* 	communityManager.getAll(pno, function(list){
				console.log('pno : ' + pno);
				console.log("list : " + list);
			}); */
			
			(function(){
				//load community
				communityManager.getAll(pno, printList)
			})();
			
			function printList(list){
				let comObj;
				for (let i=0; i<list.length; i++){
					comObj = list[i];
					let date = comObj.regDate;
					let imgUrl = "../images/atom02.png";
					let link = "#"
					let txt = "안녕하세요 우선 펀딩 올려주셔서 감사합니다. 다름이 아니라.. 펀딩 알림신청을 했을때 봤던 표지와 지금 표지가 다른 것 같은데 (아니라면 죄송합니다.)"
					+"개인적으로는 펀딩 예고때 올리셨던 갈색? 표지가 더 괜찮았는데ㅠㅠㅠ 혹시 표지가 달라질 예정은 없으실까요..?";
					let post = $("<div class=post>");
					let pf_wrap =$("<div class=pf_wrap>");
					let pf_img =$("<div class=pf_img style='background:url(" + imgUrl + ") 50% 50% no-repeat;background-size:cover;'>");
					let pf_link = $("<div class=pf_link>");
					pf_link.append($("<a href='" + link + "'><span class=name>" + comObj.name+ "</span><i class='fas fa-angle-right'></i>"));
					let regdate = $("<span class='date'>" + formatDate(date) +"</span>");
					let content = $("<div class=txt><p>"+ comObj.contents +"</p></div>");
					$(".post_list").append(post);
					pf_wrap.append(pf_img);
					pf_wrap.append(pf_link);
					pf_link.append(regdate);
					post.append(pf_wrap);
					post.append(content);
				}
			}
			
			function formatDate(timeValue){
				let date = new Date(timeValue);
				return date.getFullYear()
				+ "-" + (date.getMonth()+1 >= 10?date.getMonth()+1 : '0' + (date.getMonth()+1)) + "-" + date.getDate();
			}
			
			$(".tab_menu li").on("click", function(){
				if($(this).hasClass("tab_01")){
					$("#story").css("display", "block").siblings().hide();
				}else if($(this).hasClass("tab_02")){
					$("#community").css("display", "block").siblings().hide();
				}else if($(this).hasClass("tab_03")){
					$("#guide").css("display", "block").siblings().hide();
				}
				$(this).addClass("active").siblings().removeClass("active");
			})

			$("#pay_01").on("click", function(){
				$("#btn_payment").text("1 만 원 후원하기");
				$("._01 .money strong").text("+10000");
			});
			$("#pay_02").on("click", function(){
				$("#btn_payment").text("30 만 원 후원하기");
				$("._01 .money strong").text("+300000");
			});
			$("#pay_03").on("click", function(){
				$("#btn_payment").text("50 만 원 후원하기");
				$("._01 .money strong").text("+500000");
			});
			$("#pay_04").on("click", function(){
				$("#btn_payment").text("100 만 원 후원하기");
				$("._01 .money strong").text("+1000000");
			});

			$("#add_money").on("keypress", function(){
				let number = $(".money strong").text().replace(",", "");
				console.log(number);
				let money = console.log("수량 : " + count);
				console.log(money);
				money = money + parseInt($(this).val());
				console.log(money);
				$("._01 .money strong").text(money);
			})
			
			let count = 1; // 수량 초기값
			let moneyTxt = $(".payment._02 .money strong");
			let money = parseInt(moneyTxt.text().substring(1)); // 상품 금액

			$(".btn_minus").on("click", function(){
				if(count == 1){
					alert("수량은 1개 이상 선택 가능합니다.");
					return false;
				}				
				--count;
				let money_txt= (money*count);
				$(".incremental-input .count").text(count);
				moneyTxt.text(money_txt);
				$("#btn_payment .result_money").text(money_txt);
			})
			
			$(".btn_plus").on("click", function(){
				++count;
				let money_txt= (money*count);
				$(".incremental-input .count").text(count);
				moneyTxt.text(money_txt);
				$("#btn_payment .result_money").text(money_txt);
			})
			
			
			// 커뮤니티글 작성 
			$("#addCommunityBtn").on('click', function(){
				let title = $("#com_title").val();
				let contents = $("#com_contents").val();				  
			 	let obj = { writer:'writer',title: title, contents: contents, project_pno:pno, secret :'N'}
			  	console.log(JSON.stringify(obj));
		  		$.ajax({
		  			type:'post',
			  		url: '/community/' + obj.project_pno,
				  	data : JSON.stringify(obj),
				  	dataType:'json',
				  	contentType: "application/json",
				  	beforeSend: function (jqXHR, settings) {
		           		let header = $("meta[name='_csrf_header']").attr("content");
		           		let token = $("meta[name='_csrf']").attr("content");
		           		jqXHR.setRequestHeader(header, token);
					}
		  		}).done(function(){
		  			console.log("성공");
		  			$('#community_modal').modal('hide');
		  			communityManager.getAll(pno, printList)
	  			})
				  
			 });
			
			
			// QnA 문의하기 
			$("#addQnaBtn").on('click', function(){
				let category = $("#qna_category option:selected").val();
				let contents = $("#qna_contents").val();		
				let receiver = $("#receiver").val();
				receiver = "hansol"
				console.log("receiver : " + receiver);
				console.log("category : " + category);
				console.log("contents : " + contents);
				
			 	let obj = { writer:'qnawriter',qnacategory:category, contents: contents, member_username :receiver};
			  	console.log(JSON.stringify(obj));
			  	let url = '/qna/' + obj.member_username;
			 	console.log(url);
			 	
		  		$.ajax({
		  			type:'post',
			  		url: decodeURI(url),
				  	data : JSON.stringify(obj),
				  	dataType:'json',
				  	contentType: "application/json",
				  	beforeSend: function (jqXHR, settings) {
		           		let header = $("meta[name='_csrf_header']").attr("content");
		           		let token = $("meta[name='_csrf']").attr("content");
		           		jqXHR.setRequestHeader(header, token);
					}
		  		}).done(function(){
		  			console.log("성공");
		  			$('#qna_modal').modal('hide');
	  			})
				  
			 });
		})
	</script>
</body>
</html>